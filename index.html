<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>My Uni Notes</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body class="light">

  <!-- Soft gate UI -->
  <div id="gate" class="gate">
    <h2>Sign in</h2>
    <p>Enter password to view your notes.</p>
    <input id="pw" type="password" placeholder="Password">
    <button id="enter" class="btn">Unlock</button>
    <p id="msg" class="error"></p>
  </div>

  <!-- App -->
  <div id="app" hidden>
    <div class="app-wrap">
      <div class="sidebar">
        <h2>Subjects</h2>
        <ul id="subject-list">
          <li><a href="#" data-subject="ALL" class="active">All Files</a></li>
          <li><a href="#" data-subject="CIVL4518">CIVL4518</a></li>
          <li><a href="#" data-subject="CIVL6415">CIVL6415</a></li>
          <li><a href="#" data-subject="MATH3301">MATH3301</a></li>
          <li><a href="#" data-subject="MATH3405">MATH3405</a></li>
        </ul>
        <div class="toggle-wrap">
          <button id="toggle-dark" class="btn">üåô Toggle Dark Mode</button>
        </div>
      </div>

      <div class="content">
        <h1>Welcome to My Uni Notes</h1>
        <p id="intro">Semester 2, 2025 notes. Use the sidebar to switch subjects, search below to filter files.</p>
        <h2 id="course-title"></h2>
        <input type="text" id="search" placeholder="Search files... (filters filenames)">
        <div id="pdfs" class="group"></div>
      </div>
    </div>
  </div>

  <script>
    const PJSON_URL = "files.json";
    const SUBJECTS = ["CIVL4518", "CIVL6415", "MATH3301", "MATH3405"];
    const SUBJECT_TITLES = {
      "CIVL4518": "CIVL4518 Integrated Design for the Built Environment",
      "CIVL6415": "CIVL6415 Traffic Analysis and Simulation",
      "MATH3301": "MATH3301 Graph Theory & Design Theory",
      "MATH3405": "MATH3405 Differential Geometry"
    };

    function getFileIcon(ext) {
      ext = (ext || "").toLowerCase();
      if (ext === "pdf") return "icons/Treetog-I-PDF.256.png";
      if (["doc","docx"].includes(ext)) return "icons/Word.png";
      if (["ppt","pptx"].includes(ext)) return "icons/ppt.png";
      if (["txt"].includes(ext)) return "icons/Txt.png";
      // if (["png"].includes(ext)) return "icons/png.png"
      return "";
    }

    let data = {};
    let currentSubject = "ALL";
    let query = "";

    const pdfContainer = document.getElementById("pdfs");
    const searchInput = document.getElementById("search");
    const subjectList = document.getElementById("subject-list");
    const toggleBtn = document.getElementById("toggle-dark");
    const courseTitleEl = document.getElementById("course-title");

    const savedTheme = localStorage.getItem("theme");
    if (savedTheme === "dark") {
      document.body.classList.replace("light", "dark");
    }

    toggleBtn.addEventListener("click", () => {
      document.body.classList.toggle("dark");
      document.body.classList.toggle("light");
      localStorage.setItem("theme", document.body.classList.contains("dark") ? "dark" : "light");
    });

    subjectList.addEventListener("click", (e) => {
      const link = e.target.closest("a[data-subject]");
      if (!link) return;
      e.preventDefault();
      currentSubject = link.dataset.subject;
      searchInput.value = "";
      query = "";
      subjectList.querySelectorAll("a").forEach(a => a.classList.remove("active"));
      link.classList.add("active");
      render();
    });

    searchInput.addEventListener("input", () => {
      query = searchInput.value.trim().toLowerCase();
      render();
    });

    fetch(PJSON_URL)
      .then(r => r.json())
      .then(json => { data = json; render(); })
      .catch(() => {
        pdfContainer.innerHTML = `<p class="empty">Couldn‚Äôt load <code>${PJSON_URL}</code>. Make sure it‚Äôs in the repo root.</p>`;
      });

    /* -------------------------
       CIVL6415 extra links box
       ------------------------- */
    function buildCIVL6415Extras() {
      // container
      const extras = document.createElement("div");
      extras.style.marginTop = "16px";
      extras.style.padding = "12px 16px";
      extras.style.border = "1px solid var(--border)";
      extras.style.borderRadius = "8px";
      extras.style.background = "var(--sidebar-bg)";

      const h3 = document.createElement("h3");
      h3.textContent = "Extra Resources";
      h3.style.margin = "0 0 10px 0";
      h3.style.fontSize = "16px";
      h3.style.fontWeight = "bold";
      extras.appendChild(h3);

      const ul = document.createElement("ul");
      ul.style.listStyle = "none";
      ul.style.margin = "0";
      ul.style.padding = "0";

      const links = [
        // üîÅ Replace these URLs/titles with your real links
        { href: "https://example.com/civl6415-site", text: "üåê Course website / reference" },
        { href: "https://youtu.be/XXXXXXXXXXX", text: "üé• Traffic flow simulation video" },
        { href: "https://example.com/civl6415-reading", text: "üìò Additional reading" },
      ];

      links.forEach(l => {
        const li = document.createElement("li");
        li.style.marginBottom = "8px";
        const a = document.createElement("a");
        a.href = l.href;
        a.target = "_blank";
        a.rel = "noopener";
        a.textContent = l.text;
        a.style.textDecoration = "none";
        a.style.color = "var(--link)";
        a.style.fontWeight = "500";
        a.addEventListener("mouseover", () => a.style.opacity = "0.85");
        a.addEventListener("mouseout", () => a.style.opacity = "1");
        li.appendChild(a);
        ul.appendChild(li);
      });

      extras.appendChild(ul);
      return extras;
    }

    function render() {
      pdfContainer.innerHTML = "";

      if (currentSubject !== "ALL") {
        courseTitleEl.textContent = SUBJECT_TITLES[currentSubject] || currentSubject;
        courseTitleEl.classList.add("visible");
      } else {
        courseTitleEl.textContent = "";
        courseTitleEl.classList.remove("visible");
      }

      const toRender = currentSubject === "ALL" ? SUBJECTS : [currentSubject];
      let totalShown = 0;

      toRender.forEach(subject => {
        const files = (data[subject] || []);
        const list = document.createElement("ul");

        files.forEach(file => {
          const nameNoExt = file.replace(/\.[^/.]+$/, "");
          if (!query || nameNoExt.toLowerCase().includes(query)) {
            const fileExt = file.split(".").pop();
            const iconPath = getFileIcon(fileExt);

            const li = document.createElement("li");
            const a = document.createElement("a");
            a.href = `files/${encodeURIComponent(subject)}/${encodeURIComponent(file)}`;
            a.target = "_blank";
            a.rel = "noopener";
            a.textContent = file;

            if (iconPath) {
              const img = document.createElement("img");
              img.src = iconPath;
              img.alt = `${fileExt.toUpperCase()} file`;
              img.className = "file-icon";
              a.prepend(img);
            }

            li.appendChild(a);
            list.appendChild(li);
            totalShown++;
          }
        });

        if (list.children.length > 0) {
          const wrap = document.createElement("div");
          wrap.className = "group";
          if (currentSubject === "ALL") {
            const h2 = document.createElement("h2");
            h2.textContent = subject;
            wrap.appendChild(h2);
          }
          wrap.appendChild(list);

          // ‚¨áÔ∏è Add CIVL6415 extras ONLY for that subject
          if (subject === "CIVL6415") {
            wrap.appendChild(buildCIVL6415Extras());
          }

          pdfContainer.appendChild(wrap);
        }
      });

      if (totalShown === 0) {
        pdfContainer.innerHTML = `<p class="empty">No files match your filter${currentSubject === "ALL" ? "" : ` in <strong>${currentSubject}</strong>`}.</p>`;
      }
    }

    /* Soft Gate */
    const PASSWORD_SHA256_HEX =
      "36d00b53c4d7d2bd0ff2c1fcff6fe8858d1691418c412c60d1a8d350d92aaaed";
    const $ = s => document.querySelector(s);
    const enc = s => new TextEncoder().encode(s);
    const hex = buf => [...new Uint8Array(buf)].map(b => b.toString(16).padStart(2,"0")).join("");

    async function verify(pw) {
      const d = await crypto.subtle.digest("SHA-256", enc(pw));
      return hex(d) === PASSWORD_SHA256_HEX;
    }
    async function tryUnlock() {
      $("#msg").textContent = "";
      const ok = await verify($("#pw").value);
      if (ok) {
        $("#app").hidden = false;
        $("#gate").style.display = "none";
        sessionStorage.setItem("unlocked","1");
      } else {
        $("#msg").textContent = "Incorrect password.";
      }
    }

    if (sessionStorage.getItem("unlocked") === "1") {
      $("#app").hidden = false;
      $("#gate").style.display = "none";
    } else {
      $("#gate").style.display = "block";
      $("#enter").addEventListener("click", tryUnlock);
      $("#pw").addEventListener("keydown", e => { if (e.key === "Enter") tryUnlock(); });
    }
  </script>
</body>
</html>
